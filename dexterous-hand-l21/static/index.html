<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L21灵巧手控制系统</title>
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #1976D2;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --danger-color: #F44336;
            --text-color: #333;
            --bg-color: #f5f7fa;
            --panel-bg: #ffffff;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: var(--panel-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(22%, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: var(--panel-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .panel h2 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .control-group {
            margin-bottom: 25px;
            background: rgba(33, 150, 243, 0.05);
            padding: 15px;
            border-radius: 8px;
        }
        
        .control-group h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .slider-container {
            margin: 12px 0;
            position: relative;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .slider-label span:first-child {
            flex: 1;
            font-weight: 500;
        }
        
        .slider-value {
            min-width: 45px;
            text-align: right;
            font-weight: bold;
            color: var(--primary-color);
            background: rgba(33, 150, 243, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
            transition: var(--transition);
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--secondary-color);
        }
        
        .status-bar {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(33, 150, 243, 0.05);
            border-radius: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            transition: var(--transition);
        }
        
        .status-online {
            background: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
        }
        
        .status-offline {
            background: var(--danger-color);
            box-shadow: 0 0 8px var(--danger-color);
        }
        
        .log-container {
            background: #1e1e1e;
            color: #e0e0e0;
            padding: 20px;
            border-radius: var(--border-radius);
            font-family: 'Consolas', 'Monaco', monospace;
            height: 200px;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .log-entry {
            margin-bottom: 8px;
            font-size: 0.9rem;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .panels {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                grid-template-columns: 1fr;
            }
            
            header {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>L21灵巧手控制系统</h1>
            <p>实时精确控制灵巧手动作</p>
        </header>
        
        <div class="status-bar">
            <div class="status-item">
                <span class="status-indicator status-online" id="statusApp"></span>
                <div>
                    <div>应用状态</div>
                    <div id="appStatusText">运行中</div>
                </div>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="statusCan"></span>
                <div>
                    <div>CAN服务</div>
                    <div id="canStatusText">检查中...</div>
                </div>
            </div>
            <div class="status-item">
                <div>
                    <div>最后动作</div>
                    <div id="lastAction">无</div>
                </div>
            </div>
        </div>
        
        <div class="panels">
            <!-- 拇指控制面板 -->
            <div class="panel">
                <h2>拇指控制</h2>
                <div class="control-group">
                    <h3>旋转控制</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>旋转位置 (0-255)</span>
                            <span class="slider-value" id="thumbRotateVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="大拇指旋转" id="thumbRotate">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>旋转速度 (0-255)</span>
                            <span class="slider-value" id="thumbRotateSpeedVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="大拇指旋转速度" id="thumbRotateSpeed">
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>关节2控制</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>关节位置 (0-255)</span>
                            <span class="slider-value" id="thumbJoint2Val">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="大拇指2关节" id="thumbJoint2">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>关节速度 (0-255)</span>
                            <span class="slider-value" id="thumbJoint2SpeedVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="大拇指2关节速度" id="thumbJoint2Speed">
                    </div>
                </div>
            </div>
            
            <!-- 手指根部控制面板 -->
            <div class="panel">
                <h2>手指根部控制</h2>
                <div class="control-group">
                    <h3>位置控制 (0-255)</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>拇指根部</span>
                            <span class="slider-value" id="rootThumbVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="手指根部" data-index="0">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>食指根部</span>
                            <span class="slider-value" id="rootIndexVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="手指根部" data-index="1">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>中指根部</span>
                            <span class="slider-value" id="rootMiddleVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="手指根部" data-index="2">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>无名指根部</span>
                            <span class="slider-value" id="rootRingVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="手指根部" data-index="3">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>小指根部</span>
                            <span class="slider-value" id="rootLittleVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="手指根部" data-index="4">
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>速度控制 (0-255)</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>拇指根部速度</span>
                            <span class="slider-value" id="rootSpeedThumbVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="手指根部速度" data-index="0">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>食指根部速度</span>
                            <span class="slider-value" id="rootSpeedIndexVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="手指根部速度" data-index="1">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>中指根部速度</span>
                            <span class="slider-value" id="rootSpeedMiddleVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="手指根部速度" data-index="2">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>无名指根部速度</span>
                            <span class="slider-value" id="rootSpeedRingVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="手指根部速度" data-index="3">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>小指根部速度</span>
                            <span class="slider-value" id="rootSpeedLittleVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="手指根部速度" data-index="4">
                    </div>
                </div>
            </div>
            
            <!-- 指尖控制面板 -->
            <div class="panel">
                <h2>指尖控制</h2>
                <div class="control-group">
                    <h3>位置控制 (0-255)</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>拇指指尖</span>
                            <span class="slider-value" id="tipThumbVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="指尖" data-index="0">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>食指指尖</span>
                            <span class="slider-value" id="tipIndexVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="指尖" data-index="1">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>中指指尖</span>
                            <span class="slider-value" id="tipMiddleVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="指尖" data-index="2">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>无名指指尖</span>
                            <span class="slider-value" id="tipRingVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="指尖" data-index="3">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>小指指尖</span>
                            <span class="slider-value" id="tipLittleVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="指尖" data-index="4">
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>速度控制 (0-255)</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>拇指指尖速度</span>
                            <span class="slider-value" id="tipSpeedThumbVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="指尖速度" data-index="0">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>食指指尖速度</span>
                            <span class="slider-value" id="tipSpeedIndexVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="指尖速度" data-index="1">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>中指指尖速度</span>
                            <span class="slider-value" id="tipSpeedMiddleVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="指尖速度" data-index="2">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>无名指指尖速度</span>
                            <span class="slider-value" id="tipSpeedRingVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="指尖速度" data-index="3">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>小指指尖速度</span>
                            <span class="slider-value" id="tipSpeedLittleVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="指尖速度" data-index="4">
                    </div>
                </div>
            </div>
            
            <!-- 横摆控制面板 -->
            <div class="panel">
                <h2>横摆控制</h2>
                <div class="control-group">
                    <h3>位置控制 (0-255)</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>拇指横摆</span>
                            <span class="slider-value" id="swayThumbVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="横摆" data-index="0">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>食指横摆</span>
                            <span class="slider-value" id="swayIndexVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="横摆" data-index="1">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>中指横摆</span>
                            <span class="slider-value" id="swayMiddleVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="横摆" data-index="2">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>无名指横摆</span>
                            <span class="slider-value" id="swayRingVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="横摆" data-index="3">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>小指横摆</span>
                            <span class="slider-value" id="swayLittleVal">128</span>
                        </div>
                        <input type="range" min="0" max="255" value="128" 
                            data-command="横摆" data-index="4">
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>速度控制 (0-255)</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>拇指横摆速度</span>
                            <span class="slider-value" id="swaySpeedThumbVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="横摆速度" data-index="0">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>食指横摆速度</span>
                            <span class="slider-value" id="swaySpeedIndexVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="横摆速度" data-index="1">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>中指横摆速度</span>
                            <span class="slider-value" id="swaySpeedMiddleVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="横摆速度" data-index="2">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>无名指横摆速度</span>
                            <span class="slider-value" id="swaySpeedRingVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="横摆速度" data-index="3">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>小指横摆速度</span>
                            <span class="slider-value" id="swaySpeedLittleVal">50</span>
                        </div>
                        <input type="range" min="0" max="255" value="50" 
                            data-command="横摆速度" data-index="4">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>控制日志</h2>
            <div class="log-container" id="logContainer">
                <div class="log-entry">系统初始化完成...</div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        // 存储所有值
        const values = {
            // 单关节控制
            "大拇指旋转": 128,
            "大拇指旋转速度": 50,
            "大拇指2关节": 128,
            "大拇指2关节速度": 50,
            
            // 多关节控制
            "手指根部": [128, 128, 128, 128, 128],
            "手指根部速度": [50, 50, 50, 50, 50],
            "指尖": [128, 128, 128, 128, 128],
            "指尖速度": [50, 50, 50, 50, 50],
            "横摆": [128, 128, 128, 128, 128],
            "横摆速度": [50, 50, 50, 50, 50]
        };

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 更新滑块值显示
        function updateSliderValue(slider, value) {
            const valueElement = document.getElementById(`${slider.id}Val`);
            if (valueElement) {
                valueElement.textContent = value;
                // 添加动画效果
                valueElement.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    valueElement.style.transform = 'scale(1)';
                }, 200);
            }
        }

        // 发送控制指令
        const sendControl = debounce((command, value) => {
            fetch('/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({command, value})
            })
            .then(response => {
                if (response.ok) {
                    showToast(`指令已发送: ${command}`);
                    addLog(`${command}: ${Array.isArray(value) ? value.join(', ') : value}`);
                    return response.json();
                }
                throw new Error('网络响应错误');
            })
            .catch(error => {
                console.error('发送错误:', error);
                //showToast(`发送失败: ${command}`, 'error');
            });
        }, 100); // 100ms防抖

        // 添加日志
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            // 格式化时间
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            logEntry.textContent = `[${timeStr}] ${message}`;
            
            // 限制日志数量
            if (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 更新最后操作
        function updateLastAction(action) {
            const lastActionElem = document.getElementById('lastAction');
            lastActionElem.textContent = action;
            lastActionElem.style.color = 'var(--primary-color)';
            setTimeout(() => {
                lastActionElem.style.color = '';
            }, 1000);
        }

        // 显示通知
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            
            // 根据类型设置样式
            toast.style.background = type === 'error' 
                ? 'var(--danger-color)' 
                : 'rgba(0, 0, 0, 0.9)';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 2000);
        }

        // 检查CAN服务状态
        const checkCanService = debounce(() => {
            fetch('http://localhost:5260/api/status')
            .then(response => {
                const statusElem = document.getElementById('canStatusText');
                const indicator = document.getElementById('statusCan');
                
                if (response.ok) {
                    statusElem.textContent = '已连接';
                    indicator.className = 'status-indicator status-online';
                    indicator.style.boxShadow = '0 0 8px var(--success-color)';
                } else {
                    statusElem.textContent = '未连接';
                    indicator.className = 'status-indicator status-offline';
                    indicator.style.boxShadow = '0 0 8px var(--danger-color)';
                }
            })
            .catch(() => {
                const statusElem = document.getElementById('canStatusText');
                const indicator = document.getElementById('statusCan');
                statusElem.textContent = '未连接';
                indicator.className = 'status-indicator status-offline';
                indicator.style.boxShadow = '0 0 8px var(--danger-color)';
            });
        }, 1000);

        // 初始化滑块事件
        function initSliders() {
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const command = slider.dataset.command;
                const index = slider.dataset.index;
                
                // 设置初始值
                if (!index) {
                    slider.value = values[command];
                    updateSliderValue(slider, values[command]);
                } else {
                    const idx = parseInt(index);
                    slider.value = values[command][idx];
                    updateSliderValue(slider, values[command][idx]);
                }
                
                // 添加事件监听
                slider.addEventListener('input', function() {
                    const val = parseInt(this.value);
                    updateSliderValue(this, val);
                    
                    if (!index) {
                        values[command] = val;
                        sendControl(command, val);
                    } else {
                        const idx = parseInt(index);
                        values[command][idx] = val;
                        sendControl(command, [...values[command]]);
                    }
                    
                    updateLastAction(`${command}${index ? `[${index}]` : ''} = ${val}`);
                });
            });
        }

        // 页面加载后初始化
        window.addEventListener('DOMContentLoaded', () => {
            initSliders();
            addLog('系统初始化完成');
            checkCanService();
            setInterval(checkCanService, 5000);
        });
    </script>
</body>
</html>